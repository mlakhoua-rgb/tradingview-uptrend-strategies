//@version=5
strategy("üéØ Smart Exit Manager", overlay=true, initial_capital=10000, 
     default_qty_type=strategy.percent_of_equity, default_qty_value=100, 
     commission_type=strategy.commission.percent, commission_value=0.1)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Entry Settings
entryPrice = input.float(0, "Manual Entry Price (0 = Auto)", minval=0, 
     tooltip="Set to 0 to use strategy entry price, or manually input your entry price")
profitTarget = input.float(10.0, "Profit Target %", minval=0.1, step=0.1)
hardStopLoss = input.float(7.0, "Hard Stop Loss %", minval=0.1, step=0.1)
useTrailingStop = input.bool(true, "Use Trailing Stop After Profit")
trailingStopPercent = input.float(3.0, "Trailing Stop %", minval=0.1, step=0.1)
trailingActivation = input.float(5.0, "Trailing Stop Activation %", minval=0.1, step=0.1)

// Time-based Exit
useTimeStop = input.bool(true, "Use Time-Based Exit")
maxHoldingDays = input.int(10, "Maximum Holding Days", minval=1)

// Downtrend Detection Parameters
rsiLength = input.int(14, "RSI Length", minval=1)
emaFast = input.int(50, "Fast EMA Period", minval=1)
emaSlow = input.int(200, "Slow EMA Period", minval=1)
macdFast = input.int(12, "MACD Fast", minval=1)
macdSlow = input.int(26, "MACD Slow", minval=1)
macdSignal = input.int(9, "MACD Signal", minval=1)
adxLength = input.int(14, "ADX Length", minval=1)
stochLength = input.int(14, "Stochastic Length", minval=1)
stochSmooth = input.int(3, "Stochastic Smooth", minval=1)
bbLength = input.int(20, "Bollinger Bands Length", minval=1)
bbMult = input.float(2.0, "Bollinger Bands Multiplier", minval=0.1)
atrLength = input.int(14, "ATR Length", minval=1)

// Exit Sensitivity
exitSensitivity = input.string("Medium", "Exit Sensitivity", 
     options=["Conservative", "Medium", "Aggressive"],
     tooltip="Conservative = fewer exits, Aggressive = more exits")

// ============================================================================
// CALCULATE INDICATORS
// ============================================================================

// Moving Averages
ema50 = ta.ema(close, emaFast)
ema200 = ta.ema(close, emaSlow)

// RSI
rsi = ta.rsi(close, rsiLength)

// MACD
[macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)

// ADX
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)

// Stochastic
stochK = ta.stoch(close, high, low, stochLength)
stochD = ta.sma(stochK, stochSmooth)

// Bollinger Bands
[bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLength, bbMult)

// ATR
atr = ta.atr(atrLength)

// Volume
vol20 = ta.sma(volume, 20)

// On-Balance Volume
obv = ta.cum(math.sign(ta.change(close)) * volume)

// ============================================================================
// DOWNTREND DETECTION LOGIC
// ============================================================================

// HIGH PRIORITY EXIT SIGNALS (Immediate Exit)
bool deathCross = ta.crossunder(ema50, ema200)
bool macdBearishDiv = high > high[1] and macdLine < macdLine[1] and high[1] > high[2]
bool volumeClimax = volume > vol20 * 3 and close < open
bool breakKeySupport = ta.crossunder(close, ema50) and volume > vol20 * 1.2

highPriorityExit = deathCross or macdBearishDiv or volumeClimax or breakKeySupport

// MEDIUM PRIORITY EXIT SIGNALS (Early Warning)
bool rsiBearishDiv = high > high[1] and rsi < rsi[1] and rsi < 70
bool momentumLoss = macdHist < macdHist[1] and macdHist[1] < macdHist[2] and macdHist[2] < macdHist[3]
bool stochReversal = ta.crossunder(stochK, stochD) and stochK > 80
bool volumeDecline = volume < volume[1] and volume[1] < volume[2] and high > high[1]

mediumPriorityCount = 0
if rsiBearishDiv
    mediumPriorityCount += 1
if momentumLoss
    mediumPriorityCount += 1
if stochReversal
    mediumPriorityCount += 1
if volumeDecline
    mediumPriorityCount += 1

// CONFIRMATION SIGNALS
bool bearishEngulfing = close < open and close[1] > open[1] and 
     open >= close[1] and close <= open[1]
bool shootingStar = (high - math.max(open, close)) > (math.abs(close - open) * 2) and 
     (math.min(open, close) - low) < (math.abs(close - open) * 0.3) and close < open
bool bbRejection = high >= bbUpper and close < bbMiddle
bool adxDecline = adx < 25 and adx < adx[1]

confirmationCount = 0
if bearishEngulfing or shootingStar
    confirmationCount += 1
if bbRejection
    confirmationCount += 1
if adxDecline
    confirmationCount += 1

// EXIT DECISION LOGIC based on sensitivity
bool downtrendDetected = false

if exitSensitivity == "Aggressive"
    // Aggressive: Exit on any high priority OR 2 medium priority OR 3 medium + 1 confirmation
    downtrendDetected := highPriorityExit or mediumPriorityCount >= 2 or 
         (mediumPriorityCount >= 1 and confirmationCount >= 1)
else if exitSensitivity == "Medium"
    // Medium: Exit on high priority OR 2 medium + 1 confirmation OR 3 medium
    downtrendDetected := highPriorityExit or 
         (mediumPriorityCount >= 2 and confirmationCount >= 1) or 
         mediumPriorityCount >= 3
else  // Conservative
    // Conservative: Exit only on high priority OR 3 medium + 2 confirmation
    downtrendDetected := highPriorityExit or 
         (mediumPriorityCount >= 3 and confirmationCount >= 2)

// ============================================================================
// ENTRY LOGIC (Simple Uptrend Entry for Testing)
// ============================================================================

// Entry conditions (for backtesting purposes)
bool entryCondition = ta.crossover(ema50, ema200) or 
     (close > ema50 and close > ema200 and rsi > 50 and rsi < 70 and 
      ta.crossover(macdLine, signalLine) and volume > vol20 * 1.2)

if entryCondition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    // Store entry bar index for time-based exit
    var int entryBarIndex = bar_index

// ============================================================================
// EXIT LOGIC
// ============================================================================

// Determine actual entry price
actualEntryPrice = entryPrice > 0 ? entryPrice : strategy.position_avg_price

// Calculate profit/loss percentage
profitPercent = strategy.position_size > 0 ? 
     ((close - actualEntryPrice) / actualEntryPrice * 100) : 0

// Profit Target Exit
profitTargetReached = profitPercent >= profitTarget

// Hard Stop Loss Exit
stopLossHit = profitPercent <= -hardStopLoss

// Trailing Stop Logic
var float trailingStopPrice = na
if strategy.position_size > 0
    if profitPercent >= trailingActivation and useTrailingStop
        // Activate trailing stop
        newTrailingStop = close * (1 - trailingStopPercent / 100)
        trailingStopPrice := na(trailingStopPrice) ? newTrailingStop : 
             math.max(trailingStopPrice, newTrailingStop)
    else if profitPercent < trailingActivation
        trailingStopPrice := na
else
    trailingStopPrice := na

trailingStopHit = not na(trailingStopPrice) and close <= trailingStopPrice

// Time-based Exit
barsInTrade = strategy.position_size > 0 ? bar_index - strategy.opentrades.entry_bar_index(0) : 0
timeStopHit = useTimeStop and barsInTrade >= maxHoldingDays and profitPercent < profitTarget * 0.5

// Execute Exits
if strategy.position_size > 0
    if profitTargetReached
        strategy.close("Long", comment="üí∞ Profit Target")
    else if stopLossHit
        strategy.close("Long", comment="üõë Stop Loss")
    else if trailingStopHit
        strategy.close("Long", comment="üìâ Trailing Stop")
    else if downtrendDetected
        strategy.close("Long", comment="‚ö†Ô∏è Downtrend Detected")
    else if timeStopHit
        strategy.close("Long", comment="‚è∞ Time Stop")

// ============================================================================
// VISUAL INDICATORS
// ============================================================================

// Plot EMAs
plot(ema50, "EMA 50", color=color.new(color.blue, 0), linewidth=2)
plot(ema200, "EMA 200", color=color.new(color.red, 0), linewidth=2)

// Plot Bollinger Bands
p1 = plot(bbUpper, "BB Upper", color=color.new(color.gray, 50))
p2 = plot(bbLower, "BB Lower", color=color.new(color.gray, 50))
fill(p1, p2, color=color.new(color.gray, 90))

// Plot Entry Price Line
if strategy.position_size > 0
    line.new(bar_index[1], actualEntryPrice, bar_index, actualEntryPrice, 
         color=color.new(color.white, 0), width=2, style=line.style_dashed, 
         extend=extend.right)

// Plot Profit Target and Stop Loss Lines
if strategy.position_size > 0
    profitTargetPrice = actualEntryPrice * (1 + profitTarget / 100)
    stopLossPrice = actualEntryPrice * (1 - hardStopLoss / 100)
    
    line.new(bar_index[1], profitTargetPrice, bar_index, profitTargetPrice, 
         color=color.new(color.lime, 0), width=1, style=line.style_dotted, 
         extend=extend.right)
    line.new(bar_index[1], stopLossPrice, bar_index, stopLossPrice, 
         color=color.new(color.red, 0), width=1, style=line.style_dotted, 
         extend=extend.right)
    
    // Plot trailing stop if active
    if not na(trailingStopPrice)
        line.new(bar_index[1], trailingStopPrice, bar_index, trailingStopPrice, 
             color=color.new(color.orange, 0), width=2, style=line.style_solid, 
             extend=extend.right)

// Background colors for exit signals
bgcolor(highPriorityExit ? color.new(color.red, 80) : na, title="High Priority Exit")
bgcolor(mediumPriorityCount >= 2 ? color.new(color.orange, 90) : na, title="Medium Priority Warning")

// ============================================================================
// INFORMATION TABLE
// ============================================================================

var table infoTable = table.new(position.top_right, 2, 10, 
     bgcolor=color.new(color.black, 85), frame_color=color.gray, frame_width=1, border_width=1)

if barstate.islast and strategy.position_size > 0
    // Table header
    table.cell(infoTable, 0, 0, "Metric", text_color=color.white, 
         bgcolor=color.new(color.blue, 50), text_size=size.normal)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, 
         bgcolor=color.new(color.blue, 50), text_size=size.normal)
    
    // Position info
    table.cell(infoTable, 0, 1, "Entry Price", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(actualEntryPrice, "#.##"), 
         text_color=color.yellow, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "Current Price", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(close, "#.##"), 
         text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "P&L %", text_color=color.white, text_size=size.small)
    plColor = profitPercent > 0 ? color.lime : color.red
    table.cell(infoTable, 1, 3, str.tostring(profitPercent, "#.##") + "%", 
         text_color=plColor, text_size=size.normal)
    
    table.cell(infoTable, 0, 4, "Days in Trade", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(barsInTrade), 
         text_color=color.white, text_size=size.small)
    
    // Exit signals
    table.cell(infoTable, 0, 5, "High Priority", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, highPriorityExit ? "üî¥ YES" : "‚úÖ NO", 
         text_color=highPriorityExit ? color.red : color.lime, text_size=size.small)
    
    table.cell(infoTable, 0, 6, "Medium Signals", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 6, str.tostring(mediumPriorityCount) + "/4", 
         text_color=mediumPriorityCount >= 2 ? color.orange : color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 7, "Confirmations", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(confirmationCount) + "/3", 
         text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 8, "Downtrend Risk", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 8, downtrendDetected ? "‚ö†Ô∏è HIGH" : "‚úÖ LOW", 
         text_color=downtrendDetected ? color.red : color.lime, text_size=size.normal)
    
    table.cell(infoTable, 0, 9, "Trailing Stop", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 9, not na(trailingStopPrice) ? 
         str.tostring(trailingStopPrice, "#.##") : "Inactive", 
         text_color=not na(trailingStopPrice) ? color.orange : color.gray, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(profitTargetReached, title="üí∞ Profit Target Reached", 
     message="{{ticker}} - Profit target of " + str.tostring(profitTarget) + "% reached!")
alertcondition(downtrendDetected, title="‚ö†Ô∏è Downtrend Detected", 
     message="{{ticker}} - Downtrend signals detected! Consider exiting.")
alertcondition(highPriorityExit, title="üî¥ High Priority Exit Signal", 
     message="{{ticker}} - HIGH PRIORITY exit signal! Exit immediately!")
alertcondition(trailingStopHit, title="üìâ Trailing Stop Hit", 
     message="{{ticker}} - Trailing stop hit at " + str.tostring(trailingStopPrice))
