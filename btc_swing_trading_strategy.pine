//@version=5
strategy("BTC Swing Trading Strategy", 
     overlay=true, 
     initial_capital=5000, 
     default_qty_type=strategy.percent_of_equity, 
     default_qty_value=100,
     commission_type=strategy.commission.percent, 
     commission_value=0,
     pyramiding=0,
     calc_on_every_tick=false,
     calc_on_order_fills=false)

// ═══════════════════════════════════════════════════════════════════════════
// STRATEGY OVERVIEW
// ═══════════════════════════════════════════════════════════════════════════
// Asset: Bitcoin (BTC/USDT) only
// Capital: 5,000 EUR
// Timeframe: 1D primary + 4H confirmation (dual timeframe)
// Frequency: 20-25 trades/year (moderate, fewer but bigger wins)
// Risk per Trade: 5-7% with compounding enabled
// Commission: 0%
//
// ENTRY LOGIC:
// - Trend filter (200 EMA)
// - ADX > 25 (avoid sideways)
// - RSI pullback entries
// - Volume confirmation
// - 4H chart must confirm
// - 3-day minimum hold
//
// EXIT LOGIC:
// - ATR-based trailing stop (dynamic, adjusts to volatility)
// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS - RISK MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════
riskPerTrade = input.float(6.0, "Risk Per Trade (%)", minval=1.0, maxval=10.0, step=0.5, group="Risk Management")
minHoldBars = input.int(3, "Minimum Hold Period (Days)", minval=1, maxval=10, group="Risk Management")

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS - TREND FILTER
// ═══════════════════════════════════════════════════════════════════════════
emaLength = input.int(200, "EMA Length", minval=50, maxval=300, group="Trend Filter")
adxThreshold = input.int(25, "ADX Threshold", minval=15, maxval=40, group="Trend Filter")
adxLength = input.int(14, "ADX Length", minval=7, maxval=28, group="Trend Filter")

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS - RSI PULLBACK
// ═══════════════════════════════════════════════════════════════════════════
rsiLength = input.int(14, "RSI Length", minval=7, maxval=28, group="RSI Pullback")
rsiOversoldLevel = input.int(40, "RSI Oversold Level", minval=20, maxval=50, group="RSI Pullback")
rsiOverboughtLevel = input.int(70, "RSI Overbought Level", minval=60, maxval=80, group="RSI Pullback")

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS - VOLUME CONFIRMATION
// ═══════════════════════════════════════════════════════════════════════════
volumeMultiplier = input.float(1.3, "Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group="Volume Confirmation")
volumeMALength = input.int(20, "Volume MA Length", minval=10, maxval=50, group="Volume Confirmation")

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS - ATR TRAILING STOP
// ═══════════════════════════════════════════════════════════════════════════
atrLength = input.int(14, "ATR Length", minval=7, maxval=28, group="ATR Trailing Stop")
atrMultiplier = input.float(2.0, "ATR Multiplier", minval=1.0, maxval=5.0, step=0.5, group="ATR Trailing Stop")

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS - 4H CONFIRMATION
// ═══════════════════════════════════════════════════════════════════════════
use4HConfirmation = input.bool(true, "Use 4H Confirmation", group="4H Confirmation")

// ═══════════════════════════════════════════════════════════════════════════
// INDICATOR CALCULATIONS - DAILY TIMEFRAME
// ═══════════════════════════════════════════════════════════════════════════

// Trend Filter: 200 EMA
ema200 = ta.ema(close, emaLength)
trendUp = close > ema200

// ADX Calculation
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
adxStrong = adx > adxThreshold

// RSI Pullback
rsi = ta.rsi(close, rsiLength)
rsiPullback = rsi > rsiOversoldLevel and rsi < rsiOverboughtLevel

// Volume Confirmation
volumeMA = ta.sma(volume, volumeMALength)
volumeSurge = volume > volumeMA * volumeMultiplier

// ATR for Trailing Stop
atr = ta.atr(atrLength)

// ═══════════════════════════════════════════════════════════════════════════
// 4H TIMEFRAME CONFIRMATION
// ═══════════════════════════════════════════════════════════════════════════

// Helper function to get ADX for request.security()
getADX() =>
    [diPlus_temp, diMinus_temp, adx_temp] = ta.dmi(adxLength, adxLength)
    adx_temp

// Request 4H data
ema200_4h = request.security(syminfo.tickerid, "240", ta.ema(close, emaLength))
rsi_4h = request.security(syminfo.tickerid, "240", ta.rsi(close, rsiLength))
adx_4h = request.security(syminfo.tickerid, "240", getADX())

// 4H Confirmation Conditions
trendUp_4h = close > ema200_4h
adxStrong_4h = adx_4h > adxThreshold
rsiPullback_4h = rsi_4h > rsiOversoldLevel and rsi_4h < rsiOverboughtLevel

// Combined 4H Confirmation
confirmation_4h = trendUp_4h and adxStrong_4h and rsiPullback_4h

// ═══════════════════════════════════════════════════════════════════════════
// ENTRY CONDITIONS
// ═══════════════════════════════════════════════════════════════════════════

// Daily Timeframe Entry Conditions
dailyConditions = trendUp and adxStrong and rsiPullback and volumeSurge

// Final Entry Signal (with or without 4H confirmation)
entrySignal = use4HConfirmation ? (dailyConditions and confirmation_4h) : dailyConditions

// ═══════════════════════════════════════════════════════════════════════════
// POSITION TRACKING
// ═══════════════════════════════════════════════════════════════════════════

var float entryPrice = na
var int barsInTrade = 0
var float trailingStop = na

// Track entry and bars in trade
if strategy.position_size > 0
    if na(entryPrice)
        entryPrice := strategy.opentrades.entry_price(0)
    barsInTrade += 1
else
    entryPrice := na
    barsInTrade := 0
    trailingStop := na

// ═══════════════════════════════════════════════════════════════════════════
// ATR-BASED TRAILING STOP
// ═══════════════════════════════════════════════════════════════════════════

if strategy.position_size > 0
    // Calculate trailing stop based on ATR
    stopDistance = atr * atrMultiplier
    newTrailingStop = close - stopDistance
    
    // Update trailing stop (only move up, never down)
    if na(trailingStop)
        trailingStop := newTrailingStop
    else
        trailingStop := math.max(trailingStop, newTrailingStop)

// ═══════════════════════════════════════════════════════════════════════════
// EXIT CONDITIONS
// ═══════════════════════════════════════════════════════════════════════════

// Minimum hold period check
minHoldMet = barsInTrade >= minHoldBars

// Trailing stop exit
trailingStopHit = strategy.position_size > 0 and not na(trailingStop) and close < trailingStop and minHoldMet

// ═══════════════════════════════════════════════════════════════════════════
// STRATEGY EXECUTION
// ═══════════════════════════════════════════════════════════════════════════

// Entry
if entrySignal and strategy.position_size == 0
    strategy.entry("Long", strategy.long)

// Exit on trailing stop
if trailingStopHit
    strategy.close("Long", comment="Trailing Stop")

// ═══════════════════════════════════════════════════════════════════════════
// VISUALIZATION
// ═══════════════════════════════════════════════════════════════════════════

// Plot 200 EMA
plot(ema200, "200 EMA (Daily)", color=color.new(color.blue, 0), linewidth=2)
plot(ema200_4h, "200 EMA (4H)", color=color.new(color.purple, 50), linewidth=1)

// Plot trailing stop
plot(strategy.position_size > 0 ? trailingStop : na, "Trailing Stop", 
     color=color.new(color.red, 0), style=plot.style_linebr, linewidth=2)

// Entry/Exit markers
plotshape(entrySignal and strategy.position_size == 0, "Entry Signal", 
     shape.triangleup, location.belowbar, color=color.new(color.green, 0), size=size.small)
plotshape(trailingStopHit, "Exit Signal", 
     shape.triangledown, location.abovebar, color=color.new(color.red, 0), size=size.small)

// Background color for trend
bgcolor(trendUp ? color.new(color.green, 95) : color.new(color.red, 95))

// ═══════════════════════════════════════════════════════════════════════════
// DASHBOARD - REAL-TIME METRICS
// ═══════════════════════════════════════════════════════════════════════════

var table dashboard = table.new(position.top_right, 2, 12, 
     border_width=1, border_color=color.gray, frame_width=1, frame_color=color.gray)

if barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "BTC Swing Strategy", text_color=color.white, 
         bgcolor=color.new(color.blue, 20), text_size=size.normal)
    table.merge_cells(dashboard, 0, 0, 1, 0)
    
    // Position Status
    posStatus = strategy.position_size > 0 ? "LONG" : "FLAT"
    posColor = strategy.position_size > 0 ? color.new(color.green, 70) : color.new(color.gray, 70)
    table.cell(dashboard, 0, 1, "Position", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 1, posStatus, text_color=color.white, bgcolor=posColor)
    
    // Entry Price
    entryText = strategy.position_size > 0 ? str.tostring(entryPrice, "#,###.##") : "N/A"
    table.cell(dashboard, 0, 2, "Entry Price", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 2, entryText, text_color=color.white, bgcolor=color.new(color.gray, 90))
    
    // Current Price
    table.cell(dashboard, 0, 3, "Current Price", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 3, str.tostring(close, "#,###.##"), text_color=color.white, bgcolor=color.new(color.gray, 90))
    
    // Trailing Stop
    stopText = strategy.position_size > 0 and not na(trailingStop) ? str.tostring(trailingStop, "#,###.##") : "N/A"
    table.cell(dashboard, 0, 4, "Trailing Stop", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 4, stopText, text_color=color.white, bgcolor=color.new(color.gray, 90))
    
    // P&L %
    plPercent = strategy.position_size > 0 and not na(entryPrice) ? ((close - entryPrice) / entryPrice * 100) : 0
    plText = str.tostring(plPercent, "#.##") + "%"
    plColor = plPercent > 0 ? color.new(color.green, 70) : plPercent < 0 ? color.new(color.red, 70) : color.new(color.gray, 70)
    table.cell(dashboard, 0, 5, "P&L %", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 5, plText, text_color=color.white, bgcolor=plColor)
    
    // Bars in Trade
    barsText = strategy.position_size > 0 ? str.tostring(barsInTrade) : "0"
    table.cell(dashboard, 0, 6, "Days in Trade", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 6, barsText, text_color=color.white, bgcolor=color.new(color.gray, 90))
    
    // Trend Status
    trendText = trendUp ? "UPTREND" : "DOWNTREND"
    trendColor = trendUp ? color.new(color.green, 70) : color.new(color.red, 70)
    table.cell(dashboard, 0, 7, "Trend (1D)", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 7, trendText, text_color=color.white, bgcolor=trendColor)
    
    // ADX
    adxText = str.tostring(adx, "#.##")
    adxColor = adxStrong ? color.new(color.green, 70) : color.new(color.orange, 70)
    table.cell(dashboard, 0, 8, "ADX", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 8, adxText, text_color=color.white, bgcolor=adxColor)
    
    // RSI
    rsiText = str.tostring(rsi, "#.##")
    rsiColor = rsiPullback ? color.new(color.green, 70) : color.new(color.gray, 70)
    table.cell(dashboard, 0, 9, "RSI", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 9, rsiText, text_color=color.white, bgcolor=rsiColor)
    
    // 4H Confirmation
    confirm4hText = use4HConfirmation ? (confirmation_4h ? "✓ YES" : "✗ NO") : "DISABLED"
    confirm4hColor = use4HConfirmation ? (confirmation_4h ? color.new(color.green, 70) : color.new(color.red, 70)) : color.new(color.gray, 70)
    table.cell(dashboard, 0, 10, "4H Confirm", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 10, confirm4hText, text_color=color.white, bgcolor=confirm4hColor)
    
    // Volume Status
    volText = volumeSurge ? "✓ HIGH" : "✗ LOW"
    volColor = volumeSurge ? color.new(color.green, 70) : color.new(color.orange, 70)
    table.cell(dashboard, 0, 11, "Volume", text_color=color.white, bgcolor=color.new(color.gray, 80))
    table.cell(dashboard, 1, 11, volText, text_color=color.white, bgcolor=volColor)

// ═══════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════

alertcondition(entrySignal and strategy.position_size == 0, 
     title="BTC Swing Entry", 
     message="BTC Swing Trading: Entry Signal Triggered! Price: {{close}}, RSI: {{rsi}}, ADX: {{adx}}")

alertcondition(trailingStopHit, 
     title="BTC Swing Exit", 
     message="BTC Swing Trading: Trailing Stop Hit! Exit Price: {{close}}, P&L: {{strategy.position_avg_price}}")
