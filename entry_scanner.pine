//@version=6
indicator("ðŸŽ¯ High-Probability Uptrend Scanner", overlay=false, max_labels_count=500)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Scoring Thresholds
minScore = input.int(75, "Minimum Score for Entry", minval=0, maxval=100, 
     tooltip="Assets scoring above this threshold are considered for entry")
topN = input.int(20, "Number of Assets to Display", minval=1, maxval=20)

// Indicator Parameters
rsiLength = input.int(14, "RSI Length", minval=1)
rsiLow = input.int(40, "RSI Lower Bound", minval=0, maxval=100)
rsiHigh = input.int(70, "RSI Upper Bound", minval=0, maxval=100)
rsiOverbought = input.int(80, "RSI Overbought Level", minval=0, maxval=100)

emaFast = input.int(50, "Fast EMA Period", minval=1)
emaSlow = input.int(200, "Slow EMA Period", minval=1)
adxLength = input.int(14, "ADX Length", minval=1)
adxThreshold = input.int(25, "ADX Threshold", minval=0)

macdFast = input.int(12, "MACD Fast Length", minval=1)
macdSlow = input.int(26, "MACD Slow Length", minval=1)
macdSignal = input.int(9, "MACD Signal Length", minval=1)

stochLength = input.int(14, "Stochastic Length", minval=1)
stochSmooth = input.int(3, "Stochastic Smooth", minval=1)
stochOverbought = input.int(80, "Stochastic Overbought", minval=0, maxval=100)

volumeMultiplier = input.float(1.3, "Volume Surge Multiplier", minval=1.0, step=0.1)
atrLength = input.int(14, "ATR Length", minval=1)
bbLength = input.int(20, "Bollinger Bands Length", minval=1)
bbMult = input.float(2.0, "Bollinger Bands Multiplier", minval=0.1, step=0.1)

// ============================================================================
// SCORING FUNCTION
// ============================================================================

calcScore() =>
    var float totalScore = 0.0
    totalScore := 0.0
    
    // Calculate all indicators
    ema50 = ta.ema(close, emaFast)
    ema200 = ta.ema(close, emaSlow)
    
    // ADX Calculation
    [diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
    
    // RSI
    rsi = ta.rsi(close, rsiLength)
    
    // MACD
    [macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)
    
    // Stochastic
    stochK = ta.stoch(close, high, low, stochLength)
    stochD = ta.sma(stochK, stochSmooth)
    
    // Volume
    vol20 = ta.sma(volume, 20)
    vol5 = ta.sma(volume, 5)
    
    // On-Balance Volume
    obv = ta.cum(math.sign(ta.change(close)) * volume)
    obvSlope = ta.change(obv, 5)
    
    // ATR and Bollinger Bands
    atr = ta.atr(atrLength)
    atr50 = ta.sma(atr, 50)
    [bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLength, bbMult)
    bbWidth = bbUpper - bbLower
    bbWidthPrev = bbWidth[10]
    
    // Price Action
    highest10 = ta.highest(high, 10)
    swingLow1 = ta.lowest(low, 5)
    swingLow2 = ta.lowest(low[5], 5)
    swingLow3 = ta.lowest(low[10], 5)
    
    // ========================================================================
    // RISK FILTERS (Disqualifiers)
    // ========================================================================
    
    bool disqualified = false
    
    // Price below 200 EMA
    if close < ema200
        disqualified := true
    
    // RSI severely overbought
    if rsi > rsiOverbought
        disqualified := true
    
    // Very low volume
    if volume < vol20 * 0.5
        disqualified := true
    
    // Recent death cross
    deathCross = ta.crossunder(ema50, ema200)
    if ta.barssince(deathCross) < 20
        disqualified := true
    
    // Extreme volatility
    if atr > atr50 * 2
        disqualified := true
    
    // If disqualified, return 0 score
    if disqualified
        totalScore := 0.0
    else
        // ====================================================================
        // 1. TREND CONFIRMATION (30 points max)
        // ====================================================================
        
        float trendScore = 0.0
        
        // 50 EMA above 200 EMA
        if ema50 > ema200
            trendScore += 10.0
        
        // Price above both EMAs
        if close > ema50 and close > ema200
            trendScore += 10.0
        
        // ADX shows strong trend
        if adx > adxThreshold
            trendScore += 10.0
        
        totalScore += trendScore
        
        // ====================================================================
        // 2. MOMENTUM ANALYSIS (25 points max)
        // ====================================================================
        
        float momentumScore = 0.0
        
        // RSI in sweet spot
        if rsi >= rsiLow and rsi <= rsiHigh
            momentumScore += 8.0
        
        // MACD bullish crossover or rising
        if ta.crossover(macdLine, signalLine) or (macdLine > signalLine and macdHist > macdHist[1])
            momentumScore += 9.0
        
        // Stochastic bullish
        if ta.crossover(stochK, stochD) and stochK < stochOverbought or (stochK > stochD and stochK < stochOverbought)
            momentumScore += 8.0
        
        totalScore += momentumScore
        
        // ====================================================================
        // 3. VOLUME CONFIRMATION (20 points max)
        // ====================================================================
        
        float volumeScore = 0.0
        
        // Volume surge
        if volume > vol20 * volumeMultiplier
            volumeScore += 7.0
        
        // Volume trend up
        if vol5 > vol20
            volumeScore += 7.0
        
        // OBV trending up
        if obvSlope > 0
            volumeScore += 6.0
        
        totalScore += volumeScore
        
        // ====================================================================
        // 4. PRICE ACTION PATTERNS (15 points max)
        // ====================================================================
        
        float priceActionScore = 0.0
        
        // Higher lows
        if swingLow1 > swingLow2 and swingLow2 > swingLow3
            priceActionScore += 5.0
        
        // Breakout above 10-day high
        if close >= highest10
            priceActionScore += 5.0
        
        // Support hold at 50 EMA
        if low <= ema50 * 1.02 and close > ema50
            priceActionScore += 5.0
        
        totalScore += priceActionScore
        
        // ====================================================================
        // 5. VOLATILITY & RISK (10 points max)
        // ====================================================================
        
        float volatilityScore = 0.0
        
        // ATR increasing
        if atr > atr[5]
            volatilityScore += 3.0
        
        // Price in upper half of Bollinger Bands
        if close > bbMiddle
            volatilityScore += 4.0
        
        // Bollinger Bands expanding (squeeze release)
        if bbWidth > bbWidthPrev
            volatilityScore += 3.0
        
        totalScore += volatilityScore
    
    // Return total score
    totalScore

// ============================================================================
// SCAN MULTIPLE SYMBOLS - FIXED VERSION
// ============================================================================

// Define symbols as individual constants (Pine Script limitation workaround)
s1 = request.security("BINANCE:BTCUSDT", timeframe.period, calcScore())
s2 = request.security("BINANCE:ETHUSDT", timeframe.period, calcScore())
s3 = request.security("BINANCE:SOLUSDT", timeframe.period, calcScore())
s4 = request.security("BINANCE:BNBUSDT", timeframe.period, calcScore())
s5 = request.security("TVC:GOLD", timeframe.period, calcScore())
s6 = request.security("AMEX:GLD", timeframe.period, calcScore())
s7 = request.security("NASDAQ:AAPL", timeframe.period, calcScore())
s8 = request.security("NASDAQ:MSFT", timeframe.period, calcScore())
s9 = request.security("NASDAQ:GOOGL", timeframe.period, calcScore())
s10 = request.security("NASDAQ:NVDA", timeframe.period, calcScore())
s11 = request.security("NASDAQ:TSLA", timeframe.period, calcScore())
s12 = request.security("AMEX:SPY", timeframe.period, calcScore())
s13 = request.security("NASDAQ:QQQ", timeframe.period, calcScore())
s14 = request.security("NASDAQ:META", timeframe.period, calcScore())
s15 = request.security("NASDAQ:AMZN", timeframe.period, calcScore())
s16 = request.security("NASDAQ:AMD", timeframe.period, calcScore())
s17 = request.security("BINANCE:ADAUSDT", timeframe.period, calcScore())
s18 = request.security("BINANCE:DOGEUSDT", timeframe.period, calcScore())
s19 = request.security("NASDAQ:AVGO", timeframe.period, calcScore())
s20 = request.security("AMEX:DIA", timeframe.period, calcScore())

// Store in arrays
var array<string> symbolNames = array.from(
     "BTCUSDT", "ETHUSDT", "SOLUSDT", "BNBUSDT", "GOLD", "GLD",
     "AAPL", "MSFT", "GOOGL", "NVDA", "TSLA", "SPY", "QQQ",
     "META", "AMZN", "AMD", "ADAUSDT", "DOGEUSDT", "AVGO", "DIA")

var array<float> scores = array.from(
     s1, s2, s3, s4, s5, s6, s7, s8, s9, s10,
     s11, s12, s13, s14, s15, s16, s17, s18, s19, s20)

// ============================================================================
// DISPLAY TABLE
// ============================================================================

var table resultsTable = table.new(position.top_right, 4, 22, 
     bgcolor=color.new(color.black, 85), frame_color=color.gray, frame_width=2, border_width=1)

// Initialize table headers
if barstate.isfirst
    table.cell(resultsTable, 0, 0, "Rank", text_color=color.white, bgcolor=color.new(color.blue, 50), 
         text_size=size.normal, text_halign=text.align_center)
    table.cell(resultsTable, 1, 0, "Symbol", text_color=color.white, bgcolor=color.new(color.blue, 50), 
         text_size=size.normal, text_halign=text.align_center)
    table.cell(resultsTable, 2, 0, "Score", text_color=color.white, bgcolor=color.new(color.blue, 50), 
         text_size=size.normal, text_halign=text.align_center)
    table.cell(resultsTable, 3, 0, "Signal", text_color=color.white, bgcolor=color.new(color.blue, 50), 
         text_size=size.normal, text_halign=text.align_center)

// Sort and display
if barstate.islast
    // Create temporary arrays for sorting
    var array<float> sortedScores = array.copy(scores)
    var array<string> sortedSymbols = array.copy(symbolNames)
    
    // Bubble sort
    for i = 0 to array.size(sortedScores) - 1
        for j = 0 to array.size(sortedScores) - 2 - i
            if array.get(sortedScores, j) < array.get(sortedScores, j + 1)
                // Swap scores
                tempScore = array.get(sortedScores, j)
                array.set(sortedScores, j, array.get(sortedScores, j + 1))
                array.set(sortedScores, j + 1, tempScore)
                
                // Swap symbols
                tempSymbol = array.get(sortedSymbols, j)
                array.set(sortedSymbols, j, array.get(sortedSymbols, j + 1))
                array.set(sortedSymbols, j + 1, tempSymbol)
    
    // Display top N results
    displayCount = math.min(topN, array.size(sortedSymbols))
    
    for i = 0 to displayCount - 1
        symbol = array.get(sortedSymbols, i)
        score = array.get(sortedScores, i)
        
        // Determine signal strength
        signal = score >= 85 ? "ðŸ”¥ STRONG" : score >= minScore ? "âœ… GOOD" : "âš ï¸ WEAK"
        scoreColor = score >= 85 ? color.new(color.lime, 30) : 
             score >= minScore ? color.new(color.yellow, 30) : color.new(color.orange, 30)
        
        // Display in table
        table.cell(resultsTable, 0, i + 1, str.tostring(i + 1), 
             text_color=color.white, text_size=size.normal, text_halign=text.align_center)
        table.cell(resultsTable, 1, i + 1, symbol, 
             text_color=color.white, text_size=size.normal, text_halign=text.align_left)
        table.cell(resultsTable, 2, i + 1, str.tostring(score, "#.0"), 
             text_color=color.white, bgcolor=scoreColor, text_size=size.normal, text_halign=text.align_center)
        table.cell(resultsTable, 3, i + 1, signal, 
             text_color=color.white, text_size=size.small, text_halign=text.align_center)

// ============================================================================
// ALERTS
// ============================================================================

// Calculate score for current chart symbol
currentScore = calcScore()
strongSignal = currentScore >= 85
goodSignal = currentScore >= minScore and currentScore < 85

alertcondition(strongSignal, title="ðŸ”¥ Strong Uptrend Signal", 
     message="{{ticker}} - STRONG uptrend signal detected! Score: {{plot_0}}")
alertcondition(goodSignal, title="âœ… Good Uptrend Signal", 
     message="{{ticker}} - Good uptrend signal detected! Score: {{plot_0}}")

// Plot current symbol score for reference
plot(currentScore, title="Current Symbol Score", color=color.new(color.blue, 0), linewidth=2)
hline(minScore, "Min Score Threshold", color=color.yellow, linestyle=hline.style_dashed)
hline(85, "Strong Signal Threshold", color=color.lime, linestyle=hline.style_dashed)

// Background color based on score
bgcolor(currentScore >= 85 ? color.new(color.lime, 90) : 
     currentScore >= minScore ? color.new(color.yellow, 95) : na)
